<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Memoline</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f7fb;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h1 { color: #003366; }
    label, input, select, button { margin: 8px 0; }
    button {
      padding: 8px 16px;
      background: #0059b3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background: #004a99; }
    #centralCanvas { border:1px solid #ccc; margin-top:20px; }
    #tagInputs { display:flex; flex-direction:column; width:500px; }
    #tagInputs input { padding:5px; margin:4px 0; }
  </style>
</head>
<body>
  <h1>Memoline</h1>

  <!-- Create / Select Album -->
  <div>
    <label for="newAlbumInput">New Album:</label>
    <input type="text" id="newAlbumInput" placeholder="Album name" />
    <button type="button" id="createAlbumBtn" aria-label="Create Album">Create Album</button>
  </div>

  <div>
    <label for="albumSelect">Select Album:</label>
    <select id="albumSelect"></select>
    <button type="button" id="openAlbumBtn" aria-label="Open Album">Open Album</button>
  </div>

  <hr style="width:80%; margin:20px 0;" />

  <!-- Upload Images -->
  <div id="uploadSection" style="display:none;">
    <label for="uploadInput">Upload Images to Album:</label>
    <input type="file" id="uploadInput" multiple accept="image/*" />
    <button type="button" id="uploadBtn" aria-label="Upload Images">Upload</button>
  </div>

  <!-- Start processing -->
  <div id="processSection" style="display:none;">
    <button type="button" id="startProcessingBtn" aria-label="Start Processing">Start Processing</button>
    <div id="statusText" aria-live="polite"></div>
  </div>

  <hr style="width:80%; margin:20px 0;" />

  <!-- Show & Tag central images -->
  <div id="tagSection" style="display:none; width:100%; max-width:600px;">
    <button type="button" id="loadCentralBtn" aria-label="Show Central Images">Show Central Images</button>

    <canvas
      id="centralCanvas"
      width="500"
      height="500"
      aria-label="Central Image Canvas"
      style="display:none;"
    ></canvas>

    <div id="tagInputs" style="display:none;">
      <label for="inpPerson">Person name:</label>
      <input id="inpPerson" placeholder="Person name" />

      <label for="inpPlace">Place:</label>
      <input id="inpPlace" placeholder="Place" />

      <label for="inpTime">Time/Period:</label>
      <input id="inpTime" placeholder="Time/Period" />

      <label for="inpObjs">Objects (comma sep):</label>
      <input id="inpObjs" placeholder="Objects (comma sep)" />
    </div>

    <div>
      <button type="button" id="saveTagBtn" aria-label="Save Tag" style="display:none;">
        Save Tag
      </button>
      <button type="button" id="nextBtn" aria-label="Next Image" style="display:none;">
        Next
      </button>
      <button type="button" id="downloadTagsBtn" aria-label="Download JSON" style="display:none;">
        Download JSON
      </button>
    </div>
  </div>

  <!-- Embedded JavaScript -->
  <script>
  (() => {
    let selectedAlbum = "";
    let centralList = [], currentIndex = 0, tagData = [];

    // 1) Fetch and populate the album dropdown
    function loadAlbums() {
      fetch('/api/albums')
        .then(r => r.json())
        .then(albs => {
          const sel = document.getElementById('albumSelect');
          sel.innerHTML = '';
          albs.forEach(a => sel.add(new Option(a, a)));
        })
        .catch(console.error);
    }

    // 2) Create a new album
    document.getElementById('createAlbumBtn').onclick = () => {
      const name = document.getElementById('newAlbumInput').value.trim();
      if (!name) return alert("Enter album name");
      fetch('/api/create_album', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({album: name})
      })
      .then(r => r.json())
      .then(res => {
        if (res.error) alert(res.error);
        else
        {
          //alert(res.message);
          loadAlbums();
        }
      });
    };

    // 3) Select an album
    document.getElementById('openAlbumBtn').onclick = () => {
      selectedAlbum = document.getElementById('albumSelect').value;
      if (!selectedAlbum) return alert("Select an album");
      document.getElementById('uploadSection').style.display    = 'block';
      document.getElementById('processSection').style.display   = 'block';
      document.getElementById('tagSection').style.display       = 'block';
    };

    // 4) Upload images
    document.getElementById('uploadBtn').onclick = () => {
      const files = document.getElementById('uploadInput').files;
      if (!files.length) return alert("Choose files");
      const form = new FormData();
      form.append('album', selectedAlbum);
      for (const f of files) form.append('files', f);
      fetch('/api/upload', {method:'POST', body: form})
        .then(r => r.json())
        .then(res => {
          if (res.error) alert(res.error);
          //else alert(res.message);
        });
    };

    // 5) Start background processing
    document.getElementById('startProcessingBtn').onclick = () => {
      fetch('/api/start_processing', {
        method: 'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({album: selectedAlbum})
      })
      .then(r => r.json())
      .then(res => {
        if (res.error) alert(res.error);
        else {
          document.getElementById('statusText').textContent = "Processingâ€¦";
          pollStatus();
        }
      });
    };

    // 6) Poll status
    function pollStatus() {
      fetch(`/api/status/${encodeURIComponent(selectedAlbum)}`)
        .then(r => r.json())
        .then(js => {
          if (js.processing) setTimeout(pollStatus, 2000);
          else document.getElementById('statusText').textContent = "Processing complete!";
        });
    }

    // 7) Show central images
    document.getElementById('loadCentralBtn').onclick = () => {
      fetch(`/api/central_images/${encodeURIComponent(selectedAlbum)}`)
        .then(r => r.json())
        .then(js => {
          if (js.error) return alert(js.error);
          centralList = js.central_images || [];
          if (!centralList.length) return alert("No central images");
          ['centralCanvas','tagInputs','saveTagBtn','nextBtn','downloadTagsBtn']
            .forEach(id => document.getElementById(id).style.display='block');
          currentIndex = 0; tagData = [];
          showCurrent();
        });
    };

    // 8) Draw image in canvas
    function showCurrent() {
      const fname = centralList[currentIndex];
      const img = new Image();
      img.onload = () => {
        const c = document.getElementById('centralCanvas');
        const ctx = c.getContext('2d');
        ctx.clearRect(0,0,c.width,c.height);
        const scale = Math.min(c.width/img.width, c.height/img.height);
        ctx.drawImage(img,0,0,img.width*scale,img.height*scale);
      };
      img.src = `/uploads/${selectedAlbum}/${fname}`;
      ['inpPerson','inpPlace','inpTime','inpObjs']
        .forEach(id => document.getElementById(id).value = '');
    }

    // 9) Save tag locally
    document.getElementById('saveTagBtn').onclick = () => {
      const fname = centralList[currentIndex];
      tagData.push({
        filename: fname,
        person:   document.getElementById('inpPerson').value,
        place:    document.getElementById('inpPlace').value,
        period:   document.getElementById('inpTime').value,
        objects:  document.getElementById('inpObjs').value
                     .split(',').map(s=>s.trim()).filter(Boolean)
      });
      alert(`Tag saved for ${fname}`);
    };

    // 10) Next image
    document.getElementById('nextBtn').onclick = () => {
      if (currentIndex < centralList.length - 1) {
        currentIndex++;
        showCurrent();
      } else alert("No more images");
    };

    // 11) POST tags to server
    document.getElementById('downloadTagsBtn').onclick = () => {
      if (!tagData.length) return alert("No tags to save");
      fetch('/api/save_tags', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ album: selectedAlbum, tags: tagData })
      })
      .then(r => r.json())
      .then(res => {
        if (res.error) alert(res.error);
        //else alert(res.message);
      });
    };

    // Initial load
    loadAlbums();
  })();
  </script>
</body>
</html>
